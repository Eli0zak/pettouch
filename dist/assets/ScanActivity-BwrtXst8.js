import{j as e}from"./ui-DskC_GZ4.js";import{r as y}from"./vendor-BlHcAAdO.js";import{C as m,b as h,c as x,a as u}from"./card-BKNPTKQ9.js";import{N as P,K as U,T as f,a2 as L,R as W}from"./index-fU-TRYU7.js";import{T as Y,a as B,b as p,c as j}from"./tabs-DPPu6Y5N.js";import{A as G}from"./activity-CK0C5ic7.js";import{C as q}from"./calendar-BJg_nOUc.js";import{C as z}from"./clock-BvbAatTJ.js";import{M as H}from"./map-pin-CaB-Fh_N.js";import"./supabase-C9Ps4N4y.js";import"./charts-DDg0wrp5.js";const ae=()=>{const N=P(),[b,g]=y.useState([]),[D,c]=y.useState(!0),{toast:T}=U(),k=t=>new Intl.DateTimeFormat("ar-EG",{year:"numeric",month:"long",day:"numeric"}).format(t),E=t=>new Intl.DateTimeFormat("ar-EG",{hour:"2-digit",minute:"2-digit"}).format(t),R=async()=>{try{c(!0);const{data:{session:t}}=await f.auth.getSession();if(!t){T({title:"Unauthorized",description:"You must be logged in to view scan activity",variant:"destructive"}),N("/login");return}const{data:s,error:r}=await f.from("pets").select("id").eq("owner_id",t.user.id);if(r)throw console.error("Error fetching user pets:",r),r;if(!s||s.length===0){console.log("No pets found for user"),g([]),c(!1);return}const d=s.map(a=>a.id),{data:o,error:i}=await f.from("nfc_scans").select(`
          id,
          tag_id,
          location,
          device_info,
          created_at,
          pet_id
        `).in("pet_id",d).order("created_at",{ascending:!1});if(i)throw console.error("Error fetching scans:",i),i;if(!o||o.length===0){console.log("No scans found"),g([]),c(!1);return}const{data:I,error:w}=await f.from("pets").select("id, name, profile_image_url").in("id",d);if(w)throw console.error("Error fetching pet details:",w),w;const M=I.reduce((a,n)=>(a[n.id]=n,a),{}),A=o.map(a=>{var _,C,S;const n=a.pet_id?M[a.pet_id]:null;return{id:a.id,petName:(n==null?void 0:n.name)||"Unknown Pet",petId:a.pet_id||"",petImage:(n==null?void 0:n.profile_image_url)||null,tagId:a.tag_id,timestamp:new Date(a.created_at),location:((_=a.location)==null?void 0:_.address)||"Unknown location",scannerInfo:((C=a.device_info)==null?void 0:C.browser)||((S=a.device_info)==null?void 0:S.os)||"Unknown device"}});g(A)}catch(t){console.error("Error fetching scan records:",t),T({title:"Error",description:"Failed to load scan records. Please try again later.",variant:"destructive"})}finally{c(!1)}},v=t=>{const s=new Date,r=new Date(s.getFullYear(),s.getMonth(),s.getDate());return b.filter(d=>{const o=new Date(d.timestamp);if(t==="today")return o>=r;if(t==="week"){const i=new Date(r);return i.setDate(r.getDate()-r.getDay()),o>=i}else if(t==="month"){const i=new Date(r.getFullYear(),r.getMonth(),1);return o>=i}return!0})};y.useEffect(()=>{R()},[]);const F=t=>{N(`/dashboard/scan-details/${t}`)},l=t=>D?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-gray-900 mx-auto mb-4"}),e.jsx("p",{children:"Loading scan records..."})]}):t.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(G,{className:"mx-auto h-10 w-10 mb-4 text-gray-400"}),e.jsx("p",{children:"No NFC scan activity detected."}),e.jsx("p",{className:"mt-2",children:"When someone scans your pet's NFC tag, the activity will appear here."})]}):e.jsx("div",{className:"space-y-4",children:t.map(s=>e.jsxs("div",{className:"border rounded-lg p-4 flex flex-col md:flex-row md:items-center justify-between hover:bg-gray-50 cursor-pointer transition-colors",onClick:()=>F(s.id),children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:s.petName}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500 mt-1",children:[e.jsx(q,{className:"h-4 w-4 mr-1"}),e.jsx("span",{children:k(s.timestamp)}),e.jsx(z,{className:"h-4 w-4 mr-1 ml-3"}),e.jsx("span",{children:E(s.timestamp)})]}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500 mt-1",children:[e.jsx(H,{className:"h-4 w-4 mr-1"}),e.jsx("span",{children:s.location})]}),s.scannerInfo&&e.jsxs("div",{className:"flex items-center text-sm text-gray-500 mt-1",children:[e.jsx(L,{className:"h-4 w-4 mr-1"}),e.jsx("span",{children:s.scannerInfo})]})]}),e.jsx(W,{className:"mt-2 md:mt-0",children:"NFC Tag"})]},s.id))});return e.jsxs("div",{className:"container mx-auto py-8 px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Scan Activity"}),e.jsx("p",{className:"text-gray-600",children:"Track when and where your pets' NFC tags have been scanned"})]}),e.jsxs(Y,{defaultValue:"all",className:"mb-8",children:[e.jsxs(B,{className:"mb-4",children:[e.jsx(p,{value:"all",children:"All Scans"}),e.jsx(p,{value:"today",children:"Today"}),e.jsx(p,{value:"week",children:"This Week"}),e.jsx(p,{value:"month",children:"This Month"})]}),e.jsx(j,{value:"all",children:e.jsxs(m,{children:[e.jsx(h,{children:e.jsx(x,{children:"All Scan Records"})}),e.jsx(u,{children:l(b)})]})}),e.jsx(j,{value:"today",children:e.jsxs(m,{children:[e.jsx(h,{children:e.jsx(x,{children:"Today's Scan Records"})}),e.jsx(u,{children:l(v("today"))})]})}),e.jsx(j,{value:"week",children:e.jsxs(m,{children:[e.jsx(h,{children:e.jsx(x,{children:"This Week's Scan Records"})}),e.jsx(u,{children:l(v("week"))})]})}),e.jsx(j,{value:"month",children:e.jsxs(m,{children:[e.jsx(h,{children:e.jsx(x,{children:"This Month's Scan Records"})}),e.jsx(u,{children:l(v("month"))})]})})]})]})};export{ae as default};
