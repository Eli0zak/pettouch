import{j as e}from"./ui-DskC_GZ4.js";import{r as i}from"./vendor-BlHcAAdO.js";import{K as z,Y as a,P as k,B as A,T as n,k as Q,R as W,C as X,V as _,t as Z,a4 as ee,a5 as se}from"./index-fU-TRYU7.js";import{C as S,a as q,b as D,c as $,d as L,e as te}from"./card-BKNPTKQ9.js";import{T as re}from"./textarea-Dl2XRPf0.js";import{R as V,a as f}from"./radio-group-QkTWxcOn.js";import{S as ae,a as ie,b as ne,c as oe,d as C}from"./select-CjVjgBc2.js";import{C as B}from"./circle-alert-BLBRoTNw.js";import{L as O}from"./loader-circle-Cj1b-iFM.js";import{B as le}from"./bell-BPwAkzjx.js";import"./supabase-C9Ps4N4y.js";import"./charts-DDg0wrp5.js";const ce=({currentPlan:d,userId:N,onSuccess:u})=>{const[p,F]=i.useState("premium"),[m,h]=i.useState("3months"),[w,b]=i.useState("instapay"),[x,G]=i.useState(""),[g,v]=i.useState(""),[P,U]=i.useState(""),[s,r]=i.useState(!1),{toast:t}=z(),o={premium:{"3months":"EGP 250","6months":"EGP 450","1year":"EGP 800",lifetime:"EGP 5,000"},pro:{"3months":"EGP 500","6months":"EGP 900","1year":"EGP 1,600",lifetime:"EGP 10,000"}},E=async l=>{l.preventDefault();const{data:{session:c}}=await n.auth.getSession();if(!c){t({title:"Authentication Error",description:"You must be logged in to submit a subscription request",variant:"destructive"});return}if(!x){t({title:"Validation Error",description:"Phone number is required for payment verification",variant:"destructive"});return}try{r(!0);const j=o[p][m],R=`Duration: ${m}, Amount: ${j}${g?`, Notes: ${g}`:""}`,{error:y,data:M}=await n.from("subscription_requests").insert({user_id:N,current_plan:d,requested_plan:p,payment_method:w,phone_number:x,notes:R,transaction_proof_url:P||null,status:"pending"}).select();if(y)throw y.code==="42501"?new Error("Permission denied. Please make sure you are logged in and have permission to create subscription requests."):new Error(`Database error: ${y.message}`);console.log("Subscription request submitted:",M),t({title:"Request Submitted",description:"Your subscription upgrade request has been submitted. Our team will review it shortly."}),u&&u()}catch(j){console.error("Error submitting subscription request:",j),t({title:"Error",description:`Failed to submit request: ${j.message}`,variant:"destructive"})}finally{r(!1)}},H=async l=>{try{if(!l.target.files||l.target.files.length===0){t({title:"Error",description:"Please select a file to upload",variant:"destructive"});return}const c=l.target.files[0],j=5*1024*1024,R=["image/jpeg","image/png","image/jpg","application/pdf"];if(c.size>j){t({title:"Error",description:"File size must be less than 5MB",variant:"destructive"});return}if(!R.includes(c.type)){t({title:"Error",description:"Only JPG, PNG and PDF files are allowed",variant:"destructive"});return}const y=c.name.split(".").pop(),T=`upgrade-proofs/${`${N}-${Math.random().toString(36).substring(2)}.${y}`}`,{error:I,data:J}=await n.storage.from("subscription-uploads").upload(T,c);if(I)throw new Error(I.message||"Error uploading file");if(!J)throw new Error("Upload successful but no data returned");const{data:Y,error:K}=await n.storage.from("subscription-uploads").getPublicUrl(T);if(K||!Y)throw new Error("Failed to get public URL for uploaded file");U(Y.publicUrl),t({title:"Success",description:"Payment proof uploaded successfully"})}catch(c){console.error("Error uploading file:",c),t({title:"Error",description:c.message||"Failed to upload file",variant:"destructive"})}};return e.jsxs("form",{onSubmit:E,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(a,{children:"Select New Plan"}),e.jsxs(V,{value:p,onValueChange:F,className:"grid gap-4 pt-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(f,{value:"premium",id:"premium"}),e.jsx(a,{htmlFor:"premium",children:"Premium Plan"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(f,{value:"pro",id:"pro"}),e.jsx(a,{htmlFor:"pro",children:"Pro Plan"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(a,{children:"Subscription Duration"}),e.jsxs(ae,{value:m,onValueChange:h,children:[e.jsx(ie,{children:e.jsx(ne,{placeholder:"Select duration"})}),e.jsxs(oe,{children:[e.jsx(C,{value:"3months",children:"3 Months"}),e.jsx(C,{value:"6months",children:"6 Months (10% off)"}),e.jsx(C,{value:"1year",children:"1 Year (20% off)"}),e.jsx(C,{value:"lifetime",children:"Lifetime"})]})]}),e.jsxs("div",{className:"text-sm font-medium text-primary mt-2",children:["Price: ",o[p][m]]})]}),e.jsx(S,{className:"bg-muted",children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(B,{className:"h-5 w-5 text-muted-foreground shrink-0 mt-0.5"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsx("p",{className:"font-medium",children:"Payment Instructions"}),e.jsx("p",{className:"text-muted-foreground",children:"Please complete the payment using one of the methods below and upload the proof of payment to proceed."})]})]})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(a,{children:"Payment Method"}),e.jsxs(V,{value:w,onValueChange:b,className:"grid gap-4 pt-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(f,{value:"instapay",id:"instapay"}),e.jsx(a,{htmlFor:"instapay",children:"InstaPay"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(f,{value:"vodafone",id:"vodafone"}),e.jsx(a,{htmlFor:"vodafone",children:"Vodafone Cash"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(f,{value:"orange",id:"orange"}),e.jsx(a,{htmlFor:"orange",children:"Orange Money"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(f,{value:"etisalat",id:"etisalat"}),e.jsx(a,{htmlFor:"etisalat",children:"Etisalat Flous"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(f,{value:"wepay",id:"wepay"}),e.jsx(a,{htmlFor:"wepay",children:"WePay"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(a,{htmlFor:"phone_number",children:"Phone Number *"}),e.jsx(k,{id:"phone_number",value:x,onChange:l=>G(l.target.value),placeholder:"Enter your phone number for payment verification",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(a,{htmlFor:"transaction_proof",children:"Payment Proof *"}),e.jsx(k,{id:"transaction_proof",type:"file",onChange:H,accept:"image/png, image/jpeg, application/pdf",required:!0}),P&&e.jsx("div",{className:"text-sm text-green-600",children:"Payment proof uploaded successfully"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Please upload a clear screenshot showing the transaction details (ID, date, amount)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(a,{htmlFor:"notes",children:"Additional Notes (Optional)"}),e.jsx(re,{id:"notes",value:g,onChange:l=>v(l.target.value),placeholder:"Any additional information about your subscription request"})]})]}),e.jsx(A,{type:"submit",className:"w-full",disabled:s||!P,children:s?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"mr-2 h-4 w-4 animate-spin"}),"Submitting..."]}):"Submit Upgrade Request"})]})},ye=()=>{const{toast:d}=z(),{t:N}=Q(),[u,p]=i.useState("free"),[F,m]=i.useState(!0),[h,w]=i.useState(""),[b,x]=i.useState([]),[G,g]=i.useState(!1),v=async()=>{try{m(!0);const{data:{user:s}}=await n.auth.getUser();if(!s){d({title:"Session Error",description:"You must be logged in to access subscription features",variant:"destructive"}),m(!1);return}w(s.id);const{data:r,error:t}=await n.from("users").select("plan").eq("id",s.id).single();if(t)throw t;p(r.plan||"free");const{data:o,error:E}=await n.from("subscription_requests").select("*").eq("user_id",s.id).eq("status","pending");E?_.warn("Error fetching pending requests",{error:E,userId:s.id}):o&&x(o)}catch(s){_.error("Error fetching subscription data",{error:s,userId:h}),d({title:"Error",description:"Failed to load your subscription details.",variant:"destructive"})}finally{m(!1)}};i.useEffect(()=>{v();const s=n.channel("user-plan-changes").on("postgres_changes",{event:"UPDATE",schema:"public",table:"users",filter:`id=eq.${h}`},t=>{t.new&&t.new.plan!==u&&(p(t.new.plan||"free"),d({title:"Subscription Updated",description:`Your subscription has been updated to ${t.new.plan.charAt(0).toUpperCase()+t.new.plan.slice(1)} Plan.`}))}).subscribe(),r=n.channel("subscription-requests-changes").on("postgres_changes",{event:"*",schema:"public",table:"subscription_requests",filter:`user_id=eq.${h}`},()=>{v()}).subscribe();return()=>{n.removeChannel(s),n.removeChannel(r)}},[d,h]);const P=async s=>{try{const{error:r}=await n.from("subscription_requests").delete().eq("id",s);if(r)throw r;x(t=>t.filter(o=>o.id!==s)),d({title:"Success",description:"Your upgrade request has been cancelled."})}catch(r){_.error("Error cancelling upgrade request",{error:r,requestId:s}),d({title:"Error",description:"Failed to cancel your upgrade request.",variant:"destructive"})}},U=s=>{switch(s){case"free":return{name:"Free Plan",icon:e.jsx(se,{className:"h-5 w-5"}),features:["Manage 1 pet (name, type, breed, image)","Register and activate 1 NFC tag","Display pet profile via QR code","Report lost pets with instant notifications","Detailed NFC scan statistics","Access to e-commerce store"],price:"Free",isCurrent:u==="free"};case"premium":return{name:"Premium Plan",icon:e.jsx(ee,{className:"h-5 w-5"}),features:["Manage up to 5 pets","Register up to 5 NFC tags per pet","Add medical data with automated reminders","Customize pet profile sharing","Customize NFC tags (shapes & designs)","5% discount on store purchases"],pricing:{"3months":"EGP 250 (~EGP 83/month)","6months":"EGP 450 (EGP 75/month, 10% off)","1year":"EGP 800 (EGP 67/month, 20% off)",lifetime:"EGP 5,000 (one-time)"},isCurrent:u==="premium"};case"pro":return{name:"Pro Plan",icon:e.jsx(Z,{className:"h-5 w-5"}),features:["Manage unlimited pets","Register unlimited NFC tags","Add detailed medical notes","Advanced NFC tag customization","10% discount on store purchases","Priority support (24-hour response)"],pricing:{"3months":"EGP 500 (~EGP 167/month)","6months":"EGP 900 (EGP 150/month, 10% off)","1year":"EGP 1,600 (EGP 133/month, 20% off)",lifetime:"EGP 10,000 (one-time)"},isCurrent:u==="pro"};default:return{name:"Unknown Plan",icon:e.jsx(le,{className:"h-5 w-5"}),features:[],price:"-",isCurrent:!1}}};return e.jsx("div",{className:"container mx-auto py-6 space-y-6",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx("h1",{className:"text-3xl font-bold",children:N("dashboard.subscription")}),F?e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx(O,{className:"h-8 w-8 animate-spin"})}):e.jsx("div",{className:"grid gap-6 md:grid-cols-3",children:["free","premium","pro"].map(s=>{const r=U(s);return e.jsxs(S,{className:`relative ${r.isCurrent?"border-primary":""}`,children:[r.isCurrent&&e.jsx(W,{className:"absolute top-4 right-4",variant:"outline",children:"Current Plan"}),e.jsxs(D,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r.icon,e.jsx($,{children:r.name})]}),e.jsx(L,{children:s==="free"?"Start your PetTouch journey!":s==="premium"?"Perfect for multi-pet owners":"Ideal for breeders & businesses"})]}),e.jsxs(q,{className:"space-y-4",children:[r.price&&e.jsx("div",{className:"text-2xl font-bold",children:r.price}),r.pricing&&e.jsx("div",{className:"space-y-2",children:Object.entries(r.pricing).map(([t,o])=>e.jsx("div",{className:"text-sm",children:e.jsx("span",{className:"font-medium",children:o})},t))}),e.jsx("ul",{className:"space-y-2",children:r.features.map((t,o)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-green-500 shrink-0"}),e.jsx("span",{className:"text-sm",children:t})]},o))})]}),e.jsx(te,{children:!r.isCurrent&&s!=="free"&&e.jsxs(A,{className:"w-full",onClick:()=>g(!0),disabled:b.length>0,children:["Upgrade to ",r.name]})})]},s)})}),b.length>0&&e.jsxs(S,{className:"bg-muted",children:[e.jsx(D,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5"}),"Pending Upgrade Request"]})}),e.jsxs(q,{children:["You have a subscription upgrade request that is currently being reviewed by our team.",e.jsx(A,{variant:"outline",className:"mt-4",onClick:()=>P(b[0].id),children:"Cancel Request"})]})]}),G&&e.jsxs(S,{children:[e.jsxs(D,{children:[e.jsx($,{children:"Upgrade Your Plan"}),e.jsx(L,{children:"Choose your new plan and complete the payment process"})]}),e.jsx(q,{children:e.jsx(ce,{currentPlan:u,userId:h,onSuccess:()=>{g(!1),v()}})})]})]})})};export{ye as default};
