import{j as e}from"./ui-DskC_GZ4.js";import{r as u}from"./vendor-BlHcAAdO.js";import{K as V,T as O,B as C,O as B,P as U}from"./index-fU-TRYU7.js";import{C as Q,b as z,c as K,d as L,a as W}from"./card-BKNPTKQ9.js";import{D as G,b as X,c as Y,d as Z,e as ee}from"./dialog-D6ZzA_3-.js";import{T,a as $,b as v,c,d as F,e as o}from"./table-dY4MnRiV.js";import{S as P,a as k,b as E,c as A,d as r}from"./select-CjVjgBc2.js";import{f as se}from"./format-cwXK75ha.js";import"./supabase-C9Ps4N4y.js";import"./charts-DDg0wrp5.js";const i=t=>{if(t==null)return"";if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean")return t.toString();if(typeof t=="object")try{return JSON.stringify(t)}catch{return"[Object]"}return String(t)},p=(t,x=2)=>{if(t==null)return"0.00";if(typeof t!="number"){const j=parseFloat(t);return isNaN(j)?"0.00":j.toFixed(x)}return t.toFixed(x)},he=()=>{const{toast:t}=V(),[x,j]=u.useState([]),[q,_]=u.useState(!0),[s,b]=u.useState(null),[H,S]=u.useState(!1),[y,I]=u.useState("all"),[f,M]=u.useState("");u.useEffect(()=>{w()},[y,f]);const w=async()=>{try{_(!0);let a=O.from("store_orders").select(`
          *,
          user:user_id (
            first_name,
            last_name,
            email
          )
        `).order("created_at",{ascending:!1});y!=="all"&&(a=a.eq("status",y)),f&&(a=a.or(`id.ilike.%${f}%,tracking_number.ilike.%${f}%`));const{data:d,error:m}=await a;if(m)throw m;const l=d.map(n=>{const h={...n,total_amount:n.total_amount||0,subtotal:n.subtotal||0,shipping_fee:n.shipping_fee||0,tax:n.tax||0,discount:n.discount||0};try{typeof n.items=="string"&&(h.items=JSON.parse(n.items)),typeof n.shipping_address=="string"&&(h.shipping_address=JSON.parse(n.shipping_address)),typeof n.payment_info=="string"&&(h.payment_info=JSON.parse(n.payment_info)),Array.isArray(h.items)||(h.items=[]),h.items=h.items.map(g=>({...g,price:g.price||0,quantity:g.quantity||0})),h.shipping_address||(h.shipping_address={})}catch(g){console.error("Error parsing JSON fields:",g)}return h});j(l)}catch(a){console.error("Error fetching orders:",a),t({title:"Error",description:"Failed to load orders",variant:"destructive"})}finally{_(!1)}},J=async(a,d)=>{try{const{error:m}=await O.from("store_orders").update({status:d}).eq("id",a);m?(console.error("Order update failed:",m),t({title:"Error",description:"Failed to update order status in database",variant:"destructive"})):t({title:"Status Updated",description:`Order status updated to ${d}`}),j(x.map(l=>l.id===a?{...l,status:d}:l)),(s==null?void 0:s.id)===a&&b({...s,status:d})}catch(m){console.error("Error updating order status:",m),j(x.map(l=>l.id===a?{...l,status:d}:l)),(s==null?void 0:s.id)===a&&b({...s,status:d}),t({title:"Warning",description:"Order status updated in UI only. Database update failed.",variant:"destructive"})}},R=a=>{b(a),S(!0)},N=a=>{try{return se(new Date(a),"MMM dd, yyyy HH:mm")}catch{return a}},D=a=>{switch(a){case"pending":return"bg-yellow-100 text-yellow-800";case"processing":return"bg-blue-100 text-blue-800";case"shipped":return"bg-purple-100 text-purple-800";case"delivered":return"bg-green-100 text-green-800";case"cancelled":return"bg-red-100 text-red-800";case"refunded":return"bg-gray-100 text-gray-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Orders Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage and track customer orders"})]}),e.jsx(C,{onClick:w,variant:"outline",children:"Refresh"})]}),e.jsxs(Q,{children:[e.jsx(z,{className:"pb-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx(K,{children:"Orders"}),e.jsxs(L,{children:[x.length," total orders"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(B,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(U,{placeholder:"Search orders...",className:"pl-10 w-full sm:w-[200px]",value:f,onChange:a=>M(a.target.value)})]}),e.jsxs(P,{value:y,onValueChange:I,children:[e.jsx(k,{className:"w-full sm:w-[180px]",children:e.jsx(E,{placeholder:"Filter by status"})}),e.jsxs(A,{children:[e.jsx(r,{value:"all",children:"All Statuses"}),e.jsx(r,{value:"pending",children:"Pending"}),e.jsx(r,{value:"processing",children:"Processing"}),e.jsx(r,{value:"shipped",children:"Shipped"}),e.jsx(r,{value:"delivered",children:"Delivered"}),e.jsx(r,{value:"cancelled",children:"Cancelled"}),e.jsx(r,{value:"refunded",children:"Refunded"})]})]})]})]})}),e.jsx(W,{children:q?e.jsx("div",{className:"flex justify-center items-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"})}):x.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No orders found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(T,{children:[e.jsx($,{children:e.jsxs(v,{children:[e.jsx(c,{children:"Order ID"}),e.jsx(c,{children:"Date"}),e.jsx(c,{children:"Customer"}),e.jsx(c,{children:"Total"}),e.jsx(c,{children:"Status"}),e.jsx(c,{children:"Payment"}),e.jsx(c,{className:"text-right",children:"Actions"})]})}),e.jsx(F,{children:x.map(a=>e.jsxs(v,{children:[e.jsx(o,{className:"font-medium",children:a.id}),e.jsx(o,{children:N(a.created_at)}),e.jsx(o,{children:a.user?e.jsxs("span",{children:[i(a.user.first_name)," ",i(a.user.last_name)]}):"Unknown"}),e.jsxs(o,{children:["$",p(a.total_amount)]}),e.jsx(o,{children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${D(a.status)}`,children:a.status})}),e.jsx(o,{children:a.payment_info?i(a.payment_info.method):"N/A"}),e.jsx(o,{className:"text-right",children:e.jsx(C,{variant:"ghost",size:"sm",onClick:()=>R(a),children:"View Details"})})]},a.id))})]})})})]}),e.jsx(G,{open:H,onOpenChange:S,children:e.jsxs(X,{className:"max-w-3xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Y,{children:[e.jsx(Z,{children:"Order Details"}),e.jsxs(ee,{children:["Order ID: ",s==null?void 0:s.id]})]}),s&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Order Information"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",N(s.created_at)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Status:"}),e.jsx("span",{className:`ml-2 px-2 py-1 rounded-full text-xs font-medium ${D(s.status)}`,children:s.status})]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Tracking Number:"})," ",s.tracking_number||"Not assigned"]}),s.estimated_delivery&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Estimated Delivery:"})," ",N(s.estimated_delivery)]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Customer"}),e.jsx("div",{className:"space-y-1 text-sm",children:s.user?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Name:"})," ",i(s.user.first_name)," ",i(s.user.last_name)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Email:"})," ",i(s.user.email)]})]}):e.jsx("p",{children:"Customer information not available"})})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Shipping Address"}),e.jsx("div",{className:"space-y-1 text-sm",children:s.shipping_address?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:i(s.shipping_address.name)}),e.jsx("p",{children:i(s.shipping_address.street)}),s.shipping_address.street2&&e.jsx("p",{children:i(s.shipping_address.street2)}),e.jsxs("p",{children:[i(s.shipping_address.city),", ",i(s.shipping_address.state)," ",i(s.shipping_address.zip)]}),e.jsx("p",{children:i(s.shipping_address.country)}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Phone:"})," ",i(s.shipping_address.phone)]})]}):e.jsx("p",{children:"Shipping address not available"})}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Payment Information"}),e.jsx("div",{className:"space-y-1 text-sm",children:s.payment_info?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Method:"})," ",i(s.payment_info.method)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Status:"})," ",i(s.payment_info.status)]}),s.payment_info.transaction_id&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Transaction ID:"})," ",i(s.payment_info.transaction_id)]}),s.payment_info.paid_at&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Paid on:"})," ",N(s.payment_info.paid_at)]})]}):e.jsx("p",{children:"Payment information not available"})})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Order Items"}),e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsxs(T,{children:[e.jsx($,{children:e.jsxs(v,{children:[e.jsx(c,{children:"Product"}),e.jsx(c,{children:"Price"}),e.jsx(c,{children:"Quantity"}),e.jsx(c,{className:"text-right",children:"Total"})]})}),e.jsx(F,{children:Array.isArray(s.items)&&s.items.map((a,d)=>e.jsxs(v,{children:[e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[a.image_url&&e.jsx("img",{src:a.image_url,alt:a.product_name,className:"h-10 w-10 object-cover rounded-md"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i(a.product_name)}),a.selected_attributes&&Object.keys(a.selected_attributes).length>0&&e.jsx("div",{className:"text-xs text-muted-foreground",children:Object.entries(a.selected_attributes).map(([m,l],n)=>e.jsxs("span",{children:[m,": ",i(l),n<Object.keys(a.selected_attributes||{}).length-1?", ":""]},m))})]})]})}),e.jsxs(o,{children:["$",p(a.price)]}),e.jsx(o,{children:a.quantity||0}),e.jsxs(o,{className:"text-right",children:["$",p((a.price||0)*(a.quantity||0))]})]},d))})]})})]}),e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsx("div",{children:e.jsxs(P,{value:s.status,onValueChange:a=>J(s.id,a),children:[e.jsx(k,{className:"w-[180px]",children:e.jsx(E,{placeholder:"Update Status"})}),e.jsxs(A,{children:[e.jsx(r,{value:"pending",children:"Pending"}),e.jsx(r,{value:"processing",children:"Processing"}),e.jsx(r,{value:"shipped",children:"Shipped"}),e.jsx(r,{value:"delivered",children:"Delivered"}),e.jsx(r,{value:"cancelled",children:"Cancelled"}),e.jsx(r,{value:"refunded",children:"Refunded"})]})]})}),e.jsxs("div",{className:"space-y-1 text-right",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Subtotal:"})," $",p(s.subtotal)]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Shipping:"})," $",p(s.shipping_fee)]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Tax:"})," $",p(s.tax)]}),s.discount&&s.discount>0&&e.jsxs("div",{className:"text-sm text-green-600",children:[e.jsx("span",{className:"font-medium",children:"Discount:"})," -$",p(s.discount)]}),e.jsxs("div",{className:"text-base font-bold",children:[e.jsx("span",{children:"Total:"})," $",p(s.total_amount)]})]})]}),s.notes&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Notes"}),e.jsx("p",{className:"text-sm",children:i(s.notes)})]})]})]})})]})};export{he as default};
