import{j as e}from"./ui-DskC_GZ4.js";import{r as d}from"./vendor-BlHcAAdO.js";import{C as S,b as y,c as C,a as N}from"./card-BKNPTKQ9.js";import{N as ce,K as oe,P as q,B as o,a5 as F,R as ue,T as l,V as c}from"./index-fU-TRYU7.js";import{T as ge,a as me,b as A,c as p,d as he,e as f}from"./table-dY4MnRiV.js";import{D as B,b as U,c as V,d as H,e as R,f as z}from"./dialog-D6ZzA_3-.js";import{S as pe,a as fe,b as xe,c as je,d as $}from"./select-CjVjgBc2.js";import{T as _e,a as ve,b as D,c as k}from"./tabs-DPPu6Y5N.js";import{u as Te}from"./useTranslation-pPvXQG8Q.js";import{L as be}from"./link-Cekgv5dY.js";import"./supabase-C9Ps4N4y.js";import"./charts-DDg0wrp5.js";const Fe=()=>{const M=ce(),{toast:r}=oe(),{t:a,i18n:W}=Te(),[K,m]=d.useState([]),[G,L]=d.useState(!0),[T,J]=d.useState(""),[u,Q]=d.useState(null),[X,x]=d.useState(!1),[I,O]=d.useState([]),[g,E]=d.useState(""),[h,P]=d.useState(""),[Y,j]=d.useState(!1),[Z,we]=d.useState(window.location.origin),ee=async()=>{try{L(!0);const{data:{session:t}}=await l.auth.getSession();if(!t){r({title:a("error"),description:a("access.loginRequired"),variant:"destructive"}),M("/login");return}c.info("Fetching tags for user",{userId:t.user.id});const{data:s,error:i}=await l.from("nfc_tags").select(`
          id,
          tag_code,
          pet_id,
          user_id,
          created_at,
          activated_at,
          is_active,
          notes,
          tag_type,
          status,
          last_updated,
          pet:pet_id (
            name,
            profile_image_url
          )
        `).eq("user_id",t.user.id).order("created_at",{ascending:!1});if(i)throw c.error("Error fetching tags",{error:i,userId:t.user.id}),i;if(c.info("Tags found",{count:(s==null?void 0:s.length)||0,userId:t.user.id}),!s||s.length===0){c.info("Adding sample tag data for UI testing",{userId:t.user.id});const n=[{id:"sample-1",tag_code:"NFC001",pet_id:"sample-pet-1",user_id:t.user.id,created_at:new Date().toISOString(),activated_at:new Date().toISOString(),is_active:!0,notes:null,tag_type:"standard",status:"assigned",last_updated:new Date().toISOString(),pet:{name:"ريكس",profile_image_url:null}},{id:"sample-2",tag_code:"NFC002",pet_id:"sample-pet-2",user_id:t.user.id,created_at:new Date().toISOString(),activated_at:new Date().toISOString(),is_active:!0,notes:null,tag_type:"standard",status:"assigned",last_updated:new Date().toISOString(),pet:{name:"بيلا",profile_image_url:null}},{id:"sample-3",tag_code:"NFC003",pet_id:null,user_id:t.user.id,created_at:new Date().toISOString(),activated_at:null,is_active:!0,notes:null,tag_type:"standard",status:"unassigned",last_updated:new Date().toISOString(),pet:null}];m(n),I.length===0&&O([{id:"sample-pet-1",name:"ريكس"},{id:"sample-pet-2",name:"بيلا"}])}else m(s)}catch(t){c.error("Error fetching NFC tags",{error:t}),r({title:a("error"),description:a("common.error"),variant:"destructive"})}finally{L(!1)}},ae=async()=>{try{const{data:{session:t}}=await l.auth.getSession();if(!t)return;const{data:s,error:i}=await l.from("pets").select("id, name").eq("owner_id",t.user.id).eq("is_active",!0);if(i)throw i;O(s||[])}catch(t){c.error("Error fetching available pets",{error:t})}},te=async()=>{try{if(!h.trim()){r({title:a("error"),description:a("form.required"),variant:"destructive"});return}const{data:{session:t}}=await l.auth.getSession();if(!t){r({title:a("error"),description:a("access.loginRequired"),variant:"destructive"});return}const{data:s,error:i}=await l.from("nfc_tags").select("id").eq("tag_code",h).single();if(s){r({title:a("error"),description:a("tagExists"),variant:"destructive"});return}const{data:n,error:_}=await l.from("nfc_tags").insert({tag_code:h,user_id:t.user.id,status:"unassigned",tag_type:"standard",is_active:!0}).select().single();if(_)throw _;m(v=>[n,...v]),P(""),j(!1),r({title:a("success"),description:a("tagAdded")})}catch(t){c.error("Error adding NFC tag",{error:t,tagCode:h}),r({title:a("error"),description:a("common.error"),variant:"destructive"})}},se=async()=>{try{if(!u)return;const{data:t,error:s}=await l.from("nfc_tags").update({pet_id:g||null,status:g?"assigned":"unassigned",activated_at:g?new Date().toISOString():null}).eq("id",u.id).select(`
          id,
          tag_code,
          pet_id,
          user_id,
          created_at,
          activated_at,
          is_active,
          notes,
          tag_type,
          status,
          last_updated,
          pet:pet_id (
            name,
            profile_image_url
          )
        `).single();if(s)throw s;m(i=>i.map(n=>n.id===t.id?t:n)),x(!1),r({title:a("success"),description:a(g?"nfcTags.linkDialog.success":"tagUnlinked")})}catch(t){c.error("Error linking tag to pet",{error:t,tagId:u==null?void 0:u.id,petId:g}),r({title:a("error"),description:a("nfcTags.linkDialog.error"),variant:"destructive"})}},ie=async(t,s)=>{if(t.startsWith("sample-")){r({title:a("info"),description:"عرض توضيحي فقط. هذه البيانات عينة اختبار.",variant:"default"}),m(i=>i.map(n=>n.id===t?{...n,is_active:!s}:n));return}try{const{data:i,error:n}=await l.from("nfc_tags").update({is_active:!s}).eq("id",t).select(`
          id,
          tag_code,
          pet_id,
          user_id,
          created_at,
          activated_at,
          is_active,
          notes,
          tag_type,
          status,
          last_updated,
          pet:pet_id (
            name,
            profile_image_url
          )
        `).single();if(n)throw n;m(_=>_.map(v=>v.id===i.id?i:v)),r({title:a("success"),description:i.is_active?a("tagActivated"):a("tagDeactivated")})}catch(i){c.error("Error toggling tag status",{error:i,tagId:t,isActive:s}),r({title:a("error"),description:a("common.error"),variant:"destructive"})}},re=t=>{const s=`${Z}/tag/${t}`;navigator.clipboard.writeText(s),r({title:a("copied"),description:a("linkCopied")})},ne=t=>{if(t.id.startsWith("sample-")){r({title:a("info"),description:"عرض توضيحي فقط. هذه البيانات عينة اختبار.",variant:"default"});return}Q(t),E(t.pet_id||""),x(!0)},b=K.filter(t=>{var s;return t.tag_code.toLowerCase().includes(T.toLowerCase())||((s=t.pet)==null?void 0:s.name)&&t.pet.name.toLowerCase().includes(T.toLowerCase())});return d.useEffect(()=>{ee(),ae()},[]),e.jsxs("div",{className:"container mx-auto py-8 px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:a("dashboard.tagsManagement")}),e.jsx("p",{className:"text-gray-600",children:a("nfcTags.description")})]}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between mb-6 gap-4",children:[e.jsx("div",{className:"relative",children:e.jsx(q,{type:"text",placeholder:a("placeholder.search"),value:T,onChange:t=>J(t.target.value),className:"max-w-sm"})}),e.jsxs(o,{onClick:()=>j(!0),children:[e.jsx(F,{className:"h-4 w-4 mr-2"}),a("nfcTags.addNew")]})]}),e.jsxs(_e,{defaultValue:"all",className:"mb-8",children:[e.jsxs(ve,{className:"mb-4",children:[e.jsx(D,{value:"all",children:a("community.filters.all")}),e.jsx(D,{value:"assigned",children:a("dashboard.assigned")}),e.jsx(D,{value:"unassigned",children:a("dashboard.unassigned")})]}),e.jsx(k,{value:"all",children:e.jsxs(S,{children:[e.jsx(y,{children:e.jsx(C,{children:a("allTags")})}),e.jsx(N,{children:w(b)})]})}),e.jsx(k,{value:"assigned",children:e.jsxs(S,{children:[e.jsx(y,{children:e.jsx(C,{children:a("assignedTags")})}),e.jsx(N,{children:w(b.filter(t=>t.status==="assigned"))})]})}),e.jsx(k,{value:"unassigned",children:e.jsxs(S,{children:[e.jsx(y,{children:e.jsx(C,{children:a("unassignedTags")})}),e.jsx(N,{children:w(b.filter(t=>t.status==="unassigned"))})]})})]}),e.jsx(B,{open:Y,onOpenChange:j,children:e.jsxs(U,{children:[e.jsxs(V,{children:[e.jsx(H,{children:a("nfcTags.addDialog.title")}),e.jsx(R,{children:a("nfcTags.addDialog.description")})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"tag-code",className:"text-sm font-medium",children:a("nfcTags.tagCode")}),e.jsx(q,{id:"tag-code",placeholder:a("enterTagCode"),value:h,onChange:t=>P(t.target.value)})]})}),e.jsxs(z,{children:[e.jsx(o,{variant:"outline",onClick:()=>j(!1),children:a("button.cancel")}),e.jsx(o,{onClick:te,children:a("nfcTags.add")})]})]})}),e.jsx(B,{open:X,onOpenChange:x,children:e.jsxs(U,{children:[e.jsxs(V,{children:[e.jsx(H,{children:a("nfcTags.linkDialog.title")}),e.jsx(R,{children:a("nfcTags.linkDialog.description")})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[u&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-sm font-medium mb-1",children:[a("nfcTags.tagCode"),":"]}),e.jsx("p",{className:"font-medium",children:u.tag_code})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"pet-select",className:"text-sm font-medium",children:a("pet.name")}),e.jsxs(pe,{value:g,onValueChange:E,children:[e.jsx(fe,{children:e.jsx(xe,{placeholder:a("nfcTags.linkDialog.choosePet")})}),e.jsxs(je,{children:[e.jsx($,{value:"",children:a("unlink")}),I.map(t=>e.jsx($,{value:t.id,children:t.name},t.id))]})]})]})]}),e.jsxs(z,{children:[e.jsx(o,{variant:"outline",onClick:()=>x(!1),children:a("button.cancel")}),e.jsx(o,{onClick:se,children:a(g?"nfcTags.linkDialog.linkPet":"nfcTags.unlink")})]})]})})]});function w(t){return G?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-gray-900 mx-auto mb-4"}),e.jsx("p",{children:a("common.loading")})]}):t.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(F,{className:"mx-auto h-10 w-10 mb-4 text-gray-400"}),e.jsx("p",{children:a("nfcTags.empty.title")}),e.jsx("p",{className:"mt-2",children:a("nfcTags.empty.description")})]}):e.jsxs(ge,{children:[e.jsx(me,{children:e.jsxs(A,{children:[e.jsx(p,{children:a("nfcTags.tagCode")}),e.jsx(p,{children:a("nfcTags.status")}),e.jsx(p,{children:a("nfcTags.linkedPet")}),e.jsx(p,{children:a("nfcTags.addedOn")}),e.jsx(p,{children:a("admin.common.actions")})]})}),e.jsx(he,{children:t.map(s=>e.jsxs(A,{children:[e.jsx(f,{className:"font-medium",children:s.tag_code}),e.jsx(f,{children:e.jsx(ue,{variant:de(s.status),className:`${s.is_active?"":"opacity-50"}`,children:le(s.status,s.is_active)})}),e.jsx(f,{children:s.pet?s.pet.name:a("nfcTags.notLinked")}),e.jsx(f,{children:new Date(s.created_at).toLocaleDateString(W.language)}),e.jsx(f,{children:e.jsxs("div",{className:"flex space-x-2 rtl:space-x-reverse",children:[e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>ne(s),children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),s.pet_id?a("changeLink"):a("link")]}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>ie(s.id,s.is_active),children:s.is_active?a("deactivate"):a("activate")}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>re(s.tag_code),children:a("nfcTags.copyLink")})]})})]},s.id))})]})}function de(t){switch(t){case"assigned":return"default";case"unassigned":return"secondary";case"lost":return"destructive";case"disabled":return"outline";default:return"outline"}}function le(t,s){if(!s)return a("dashboard.deactivated");switch(t){case"assigned":return a("dashboard.assigned");case"unassigned":return a("dashboard.unassigned");case"lost":return a("lost.status.lost");case"disabled":return a("dashboard.deactivated");default:return t}}};export{Fe as default};
