import{j as e}from"./ui-DskC_GZ4.js";import{r as c}from"./vendor-BlHcAAdO.js";import{c as ne,K as ie,T as m,O as le,P as oe,a3 as ce,B as d,Y as l,R as b}from"./index-fU-TRYU7.js";import{C as M,a as V,c as O,d as de,b as ue}from"./card-BKNPTKQ9.js";import{T as me,f as he,a as pe,b as Q,c as h,d as xe,e as p}from"./table-dY4MnRiV.js";import{D as W,a as je,b as K,c as X,d as Y,e as fe,f as Z}from"./dialog-D6ZzA_3-.js";import{S as ge,a as ve,c as Ne,d as C}from"./select-CjVjgBc2.js";import{T as we}from"./textarea-Dl2XRPf0.js";import{F as be}from"./filter-Y_kipbuI.js";import{C as Ce}from"./circle-alert-BLBRoTNw.js";import{I as _e}from"./info-Dqd7-vNn.js";import{C as ye}from"./circle-check-big-C5mTEYhf.js";import{C as De}from"./circle-x-sU9EccIO.js";import{f as Se}from"./format-cwXK75ha.js";import"./supabase-C9Ps4N4y.js";import"./charts-DDg0wrp5.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=ne("FileImage",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]),Ve=()=>{var U,z;const{toast:f}=ie(),[_,y]=c.useState([]),[J,P]=c.useState(!0),[g,ee]=c.useState("all"),[v,se]=c.useState(""),[q,D]=c.useState(""),[k,N]=c.useState(null),[S,T]=c.useState(!1),[t,re]=c.useState(null),[te,x]=c.useState(!1);c.useEffect(()=>{const s=async()=>{P(!0);try{console.log("Fetching subscription requests...");const{data:a,error:o}=await m.from("subscription_requests").select("*").order("created_at",{ascending:!1});if(o)throw console.error("Error fetching subscription requests:",o),o;if(console.log("Fetched requests:",a),a&&a.length>0){const i=await Promise.all(a.map(async n=>{const{data:u,error:j}=await m.from("users").select("first_name, last_name, email").eq("id",n.user_id).single();return j?(console.warn(`Could not fetch user details for request ${n.id}:`,j),{...n,user:null}):{...n,user:u}}));y(i)}else y([])}catch(a){console.error("Error fetching upgrade requests:",a),f({title:"Error",description:"Failed to load upgrade requests.",variant:"destructive"})}finally{P(!1)}};s();const r=m.channel("custom-upgrade-requests-channel").on("postgres_changes",{event:"*",schema:"public",table:"subscription_requests"},()=>{s()}).subscribe();return()=>{m.removeChannel(r)}},[f]);const R=async(s,r,a)=>{T(!0);try{const{error:o}=await m.from("subscription_requests").update({status:r,notes:a||void 0}).eq("id",s);if(o)throw o;if(r==="approved"){const i=_.find(n=>n.id===s);if(i){console.log(`Approving subscription request for user ${i.user_id} to upgrade to ${i.requested_plan}`);const{error:n}=await m.from("users").update({plan:i.requested_plan}).eq("id",i.user_id);if(n)throw new Error(`Failed to update user plan: ${n.message}`);const{error:u}=await m.from("subscription_history").insert({user_id:i.user_id,previous_plan:i.current_plan,new_plan:i.requested_plan,change_date:new Date().toISOString(),request_id:s});u&&console.warn("Could not record subscription history:",u)}}y(i=>i.map(n=>n.id===s?{...n,status:r,notes:a}:n)),f({title:"Success",description:`Upgrade request ${r==="approved"?"approved":"rejected"} successfully.`}),N(null),D("")}catch(o){console.error(`Error ${r==="approved"?"approving":"rejecting"} request:`,o),f({title:"Error",description:`Failed to ${r==="approved"?"approve":"reject"} the request.`,variant:"destructive"})}finally{T(!1)}},ae=()=>{let s=_;if(g!=="all"&&(s=s.filter(r=>r.status===g)),v){const r=v.toLowerCase();s=s.filter(a=>{var o,i,n,u,j,I,$,B,H;return((o=a.phone_number)==null?void 0:o.toLowerCase().includes(r))||((i=a.user_id)==null?void 0:i.toLowerCase().includes(r))||((n=a.payment_method)==null?void 0:n.toLowerCase().includes(r))||((j=(u=a.user)==null?void 0:u.email)==null?void 0:j.toLowerCase().includes(r))||(($=(I=a.user)==null?void 0:I.first_name)==null?void 0:$.toLowerCase().includes(r))||((H=(B=a.user)==null?void 0:B.last_name)==null?void 0:H.toLowerCase().includes(r))})}return s},F=s=>{switch(s){case"pending":return e.jsx(b,{variant:"outline",className:"bg-yellow-100 text-yellow-800",children:"Pending"});case"approved":return e.jsx(b,{variant:"outline",className:"bg-green-100 text-green-800",children:"Approved"});case"rejected":return e.jsx(b,{variant:"outline",className:"bg-red-100 text-red-800",children:"Rejected"});default:return e.jsx(b,{children:s})}},A=s=>{try{return Se(new Date(s),"PPP")}catch{return s}},E=s=>{const r=s.user;return r?r!=null&&r.first_name||r!=null&&r.last_name?`${(r==null?void 0:r.first_name)||""} ${(r==null?void 0:r.last_name)||""}`.trim():(r==null?void 0:r.email)||"Unnamed Customer":"Unknown User"},L=s=>{re(s),x(!0)},w=ae();return console.log("Filtered requests:",w),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Subscription Upgrade Requests"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage and process customer subscription upgrade requests."})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsxs("div",{className:"relative w-full sm:w-auto",children:[e.jsx(le,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(oe,{placeholder:"Search by name, email, or phone...",className:"pl-8 w-full sm:w-[200px] lg:w-[300px]",value:v,onChange:s=>se(s.target.value)})]}),e.jsxs(ge,{value:g,onValueChange:ee,children:[e.jsx(ve,{className:"w-[130px]",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Filter"})]})}),e.jsxs(Ne,{children:[e.jsx(C,{value:"all",children:"All Statuses"}),e.jsx(C,{value:"pending",children:"Pending"}),e.jsx(C,{value:"approved",children:"Approved"}),e.jsx(C,{value:"rejected",children:"Rejected"})]})]})]})]}),J?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(ce,{size:"lg",text:"Loading upgrade requests..."})}):w.length===0?e.jsx(M,{children:e.jsxs(V,{className:"flex flex-col items-center justify-center py-16",children:[e.jsx(Ce,{className:"h-16 w-16 text-muted-foreground mb-4"}),e.jsx(O,{className:"mb-2",children:"No upgrade requests found"}),e.jsx(de,{children:g!=="all"||v?"Try changing your filters or search query":"When customers request subscription upgrades, they will appear here"})]})}):e.jsxs(M,{children:[e.jsx(ue,{children:e.jsx(O,{children:"Subscription Requests"})}),e.jsx(V,{children:e.jsxs(me,{children:[e.jsxs(he,{children:["Showing ",w.length," of ",_.length," subscription upgrade requests"]}),e.jsx(pe,{children:e.jsxs(Q,{children:[e.jsx(h,{children:"Date"}),e.jsx(h,{children:"Customer"}),e.jsx(h,{children:"Current Plan"}),e.jsx(h,{children:"Requested Plan"}),e.jsx(h,{children:"Payment Method"}),e.jsx(h,{children:"Status"}),e.jsx(h,{children:"Actions"})]})}),e.jsx(xe,{children:w.map(s=>{var r;return e.jsxs(Q,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>L(s),children:[e.jsx(p,{className:"font-medium whitespace-nowrap",children:A(s.created_at)}),e.jsx(p,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:E(s)}),e.jsx("span",{className:"text-sm text-muted-foreground",children:((r=s.user)==null?void 0:r.email)||"No email"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Phone: ",s.phone_number||"Not provided"]})]})}),e.jsx(p,{className:"capitalize",children:s.current_plan||"Unknown"}),e.jsx(p,{className:"capitalize",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:s.requested_plan||"Unknown"}),s.notes&&s.notes.includes("Duration:")&&e.jsx("span",{className:"text-xs text-muted-foreground",children:s.notes.split(",").filter(a=>a.includes("Duration:")||a.includes("Amount:")).join(", ")})]})}),e.jsx(p,{className:"capitalize",children:s.payment_method||"Not specified"}),e.jsx(p,{children:F(s.status)}),e.jsx(p,{children:e.jsxs("div",{className:"flex gap-2",children:[s.transaction_proof_url&&e.jsx(d,{variant:"outline",size:"icon",asChild:!0,title:"View payment proof",onClick:a=>{a.stopPropagation(),window.open(s.transaction_proof_url,"_blank")},children:e.jsx("a",{href:s.transaction_proof_url,target:"_blank",rel:"noopener noreferrer",children:e.jsx(G,{className:"h-4 w-4"})})}),e.jsx(d,{variant:"outline",size:"icon",title:"View details",onClick:a=>{a.stopPropagation(),L(s)},children:e.jsx(_e,{className:"h-4 w-4"})}),s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(d,{variant:"outline",size:"icon",className:"text-green-500 hover:text-green-700",title:"Approve request",onClick:a=>{a.stopPropagation(),R(s.id,"approved")},disabled:S,children:e.jsx(ye,{className:"h-4 w-4"})}),e.jsxs(W,{children:[e.jsx(je,{asChild:!0,children:e.jsx(d,{variant:"outline",size:"icon",className:"text-red-500 hover:text-red-700",title:"Reject request",onClick:a=>{a.stopPropagation(),N(s.id)},children:e.jsx(De,{className:"h-4 w-4"})})}),e.jsxs(K,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Reject Upgrade Request"}),e.jsx(fe,{children:"Provide a reason for rejecting this upgrade request. This will be communicated to the user."})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{htmlFor:"rejectReason",children:"Reason for rejection (optional)"}),e.jsx(we,{id:"rejectReason",placeholder:"Enter reason for rejection...",value:q,onChange:a=>D(a.target.value)})]})}),e.jsxs(Z,{children:[e.jsx(d,{variant:"outline",onClick:()=>{N(null),D("")},children:"Cancel"}),e.jsx(d,{variant:"destructive",onClick:()=>{k&&R(k,"rejected",q)},disabled:S,children:"Reject Request"})]})]})]})]})]})})]},s.id)})})]})})]}),e.jsx(W,{open:te,onOpenChange:x,children:e.jsxs(K,{className:"max-w-md",children:[e.jsx(X,{children:e.jsx(Y,{children:"Upgrade Request Details"})}),t&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Customer"}),e.jsx("div",{className:"font-medium",children:E(t)})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Status"}),e.jsx("div",{children:F(t.status)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Current Plan"}),e.jsx("div",{className:"font-medium capitalize",children:t.current_plan})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Requested Plan"}),e.jsx("div",{className:"font-medium capitalize",children:t.requested_plan})]})]}),t.notes&&t.notes.includes("Duration:")&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.notes.includes("Duration:")&&e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Duration"}),e.jsx("div",{className:"font-medium",children:(U=t.notes.split(",").find(s=>s.includes("Duration:")))==null?void 0:U.replace("Duration:","").trim()})]}),t.notes.includes("Amount:")&&e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Amount"}),e.jsx("div",{className:"font-medium",children:(z=t.notes.split(",").find(s=>s.includes("Amount:")))==null?void 0:z.replace("Amount:","").trim()})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Payment Method"}),e.jsx("div",{className:"font-medium capitalize",children:t.payment_method})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Phone Number"}),e.jsx("div",{className:"font-medium",children:t.phone_number||"Not provided"})]})]}),t.notes&&t.notes.includes("Notes:")&&e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Additional Notes"}),e.jsx("div",{className:"font-medium",children:t.notes.split("Notes:")[1].trim()})]}),t.notes&&!t.notes.includes("Duration:")&&!t.notes.includes("Notes:")&&e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Notes"}),e.jsx("div",{className:"font-medium",children:t.notes})]}),t.transaction_proof_url&&e.jsxs("div",{children:[e.jsx(l,{className:"text-muted-foreground",children:"Payment Proof"}),e.jsx("div",{className:"mt-1",children:e.jsx(d,{variant:"outline",className:"w-full",asChild:!0,children:e.jsxs("a",{href:t.transaction_proof_url,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),"View Payment Proof"]})})})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx(l,{className:"text-muted-foreground",children:"Date Submitted"}),e.jsx("div",{className:"font-medium",children:A(t.created_at)})]})]}),e.jsxs(Z,{className:"mt-4",children:[e.jsx(d,{variant:"outline",onClick:()=>x(!1),children:"Close"}),t&&t.status==="pending"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"default",className:"bg-green-600 hover:bg-green-700",onClick:()=>{t&&(R(t.id,"approved"),x(!1))},disabled:S,children:"Approve"}),e.jsx(d,{variant:"destructive",onClick:()=>{t&&(N(t.id),x(!1))},children:"Reject"})]})]})]})})]})};export{Ve as default};
