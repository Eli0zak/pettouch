import{j as e}from"./ui-DskC_GZ4.js";import{r as x}from"./vendor-BlHcAAdO.js";import{C as w,b as y,c as N,a as _}from"./card-BKNPTKQ9.js";import{N as O,K as W,T as g,V as o,a2 as z,R as G}from"./index-fU-TRYU7.js";import{T as J,a as Q,b,c as S}from"./tabs-DPPu6Y5N.js";import{S as X,a as Z,b as ee,c as te,d as M}from"./select-CjVjgBc2.js";import{u as se}from"./useTranslation-pPvXQG8Q.js";import{F as re}from"./filter-Y_kipbuI.js";import{A as ae}from"./activity-CK0C5ic7.js";import{C as ne}from"./calendar-BJg_nOUc.js";import{C as ie}from"./clock-BvbAatTJ.js";import{M as oe}from"./map-pin-CaB-Fh_N.js";import"./supabase-C9Ps4N4y.js";import"./charts-DDg0wrp5.js";const Ne=()=>{const R=O(),[C,I]=x.useState([]),[V,p]=x.useState(!0),[u,q]=x.useState("all"),[A,B]=x.useState([]),{toast:D}=W(),{t:r,i18n:T}=se(),$=s=>new Intl.DateTimeFormat(T.language,{year:"numeric",month:"long",day:"numeric"}).format(s),L=s=>new Intl.DateTimeFormat(T.language,{hour:"2-digit",minute:"2-digit"}).format(s),U=async()=>{try{p(!0);const{data:{session:s}}=await g.auth.getSession();if(!s){D({title:r("error"),description:r("access.loginRequired"),variant:"destructive"}),R("/login");return}o.info("Fetching scan records for user",{userId:s.user.id});const{data:n,error:a}=await g.from("nfc_tags").select("id, tag_code, pet_id").eq("user_id",s.user.id);if(a)throw o.error("Error fetching user tags",{error:a,userId:s.user.id}),a;if(o.info("User tags",{userTags:n,count:(n==null?void 0:n.length)||0}),!n||n.length===0){o.info("No tags found for user",{userId:s.user.id}),I([]),p(!1);return}const m=n.map(t=>t.tag_code),{data:i,error:f}=await g.from("nfc_scans").select(`
          id,
          tag_id,
          location,
          device_info,
          created_at,
          scanner_ip,
          pet_id
        `).in("tag_id",m).order("created_at",{ascending:!1});if(f)throw o.error("Error fetching scans",{error:f,tagCodes:m}),f;if(o.info("Scans found",{scans:i,count:(i==null?void 0:i.length)||0}),!i||i.length===0){o.info("No scans found",{tagCodes:m}),I([]),p(!1);return}const c=[...new Set(i.filter(t=>t.pet_id).map(t=>t.pet_id))];let E={};if(c.length>0){const{data:t,error:l}=await g.from("pets").select("id, name, profile_image_url").in("id",c);l?o.error("Error fetching pets",{error:l,petIds:c}):t&&(E=t.reduce((h,d)=>(h[d.id]=d,h),{}))}const P=i.map(t=>{const l=t.pet_id?E[t.pet_id]:null;let h="";if(t.device_info){const v=[];t.device_info.browser&&v.push(t.device_info.browser),t.device_info.os&&v.push(t.device_info.os),t.device_info.device&&v.push(t.device_info.device),h=v.join(" / ")||r("tagPage.unknown")}else h=r("tagPage.unknown");let d="";return t.location?t.location.address?d=t.location.address:t.location.coordinates?d=`${t.location.coordinates.lat.toFixed(4)}, ${t.location.coordinates.lng.toFixed(4)}`:d=r("tagPage.unknown"):d=r("tagPage.unknown"),{id:t.id,petName:(l==null?void 0:l.name)||r("tagPage.unknown"),petId:t.pet_id||"",petImage:(l==null?void 0:l.profile_image_url)||null,tagId:t.tag_id,timestamp:new Date(t.created_at),location:d,scannerInfo:h}});o.info("Formatted records",{formattedRecords:P,count:P.length}),I(P);const{data:F,error:K}=await g.from("pets").select("id, name").eq("owner_id",s.user.id);!K&&F&&B(F)}catch(s){o.error("Error fetching scan records",{error:s}),D({title:r("error"),description:r("common.error"),variant:"destructive"})}finally{p(!1)}},k=s=>{const n=new Date,a=new Date(n.getFullYear(),n.getMonth(),n.getDate());let m=C;return u!=="all"&&(m=m.filter(i=>i.petId===u)),m.filter(i=>{const f=new Date(i.timestamp);if(s==="today")return f>=a;if(s==="week"){const c=new Date(a);return c.setDate(a.getDate()-a.getDay()),f>=c}else if(s==="month"){const c=new Date(a.getFullYear(),a.getMonth(),1);return f>=c}return!0})};x.useEffect(()=>{U()},[]);const Y=s=>{R(`/dashboard/scan-details/${s}`)},H=s=>u==="all"?s:s.filter(n=>n.petId===u),j=s=>{const n=H(s);return V?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-gray-900 mx-auto mb-4"}),e.jsx("p",{children:r("common.loading")})]}):n.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(ae,{className:"mx-auto h-10 w-10 mb-4 text-gray-400"}),e.jsx("p",{children:r("common.noData")}),e.jsx("p",{className:"mt-2",children:r("dashboard.startTracking")})]}):e.jsx("div",{className:"space-y-4",children:n.map(a=>e.jsxs("div",{className:"border rounded-lg p-4 flex flex-col md:flex-row md:items-center justify-between hover:bg-gray-50 cursor-pointer transition-colors",onClick:()=>Y(a.id),children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:a.petName}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500 mt-1",children:[e.jsx(ne,{className:"h-4 w-4 ml-1"}),e.jsx("span",{children:$(a.timestamp)}),e.jsx(ie,{className:"h-4 w-4 ml-1 mr-3"}),e.jsx("span",{children:L(a.timestamp)})]}),e.jsxs("div",{className:"flex items-center text-sm text-gray-500 mt-1",children:[e.jsx(oe,{className:"h-4 w-4 ml-1"}),e.jsx("span",{children:a.location})]}),a.scannerInfo&&e.jsxs("div",{className:"flex items-center text-sm text-gray-500 mt-1",children:[e.jsx(z,{className:"h-4 w-4 ml-1"}),e.jsx("span",{children:a.scannerInfo})]})]}),e.jsx(G,{className:"mt-2 md:mt-0",children:r("tagPage.nfcTag")})]},a.id))})};return e.jsxs("div",{className:"container mx-auto py-8 px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:r("dashboard.scanRecords")}),e.jsx("p",{className:"text-gray-600",children:r("features.tracking.description")})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5 text-gray-500"}),e.jsxs("span",{className:"text-sm font-medium",children:[r("store.filters"),":"]})]}),e.jsxs(X,{value:u,onValueChange:q,children:[e.jsx(Z,{className:"w-full md:w-64 mt-2",children:e.jsx(ee,{placeholder:r("nfcTags.linkDialog.choosePet")})}),e.jsxs(te,{children:[e.jsx(M,{value:"all",children:r("community.filters.all")}),A.map(s=>e.jsx(M,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs(J,{defaultValue:"all",className:"mb-8",children:[e.jsxs(Q,{className:"mb-4",children:[e.jsx(b,{value:"all",children:r("store.allOrders")}),e.jsx(b,{value:"today",children:r("today")}),e.jsx(b,{value:"week",children:r("thisWeek")}),e.jsx(b,{value:"month",children:r("thisMonth")})]}),e.jsx(S,{value:"all",children:e.jsxs(w,{children:[e.jsx(y,{children:e.jsx(N,{children:r("allScanRecords")})}),e.jsx(_,{children:j(C)})]})}),e.jsx(S,{value:"today",children:e.jsxs(w,{children:[e.jsx(y,{children:e.jsx(N,{children:r("todayScanRecords")})}),e.jsx(_,{children:j(k("today"))})]})}),e.jsx(S,{value:"week",children:e.jsxs(w,{children:[e.jsx(y,{children:e.jsx(N,{children:r("weeklyScanRecords")})}),e.jsx(_,{children:j(k("week"))})]})}),e.jsx(S,{value:"month",children:e.jsxs(w,{children:[e.jsx(y,{children:e.jsx(N,{children:r("monthlyScanRecords")})}),e.jsx(_,{children:j(k("month"))})]})})]})]})};export{Ne as default};
